<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Калькулятор Gloss Master</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-page: #f9fafb;
            --brand-red: #b91c1c; 
            --brand-dark: #1f2937;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-page);
            color: var(--brand-dark);
            -webkit-tap-highlight-color: transparent;
            /* Исправление прокрутки в Telegram iOS */
            padding-bottom: 20px;
        }

        .mat-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .mat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .mat-card.active { border-color: var(--brand-red); background-color: #fef2f2; }
        .mat-card.active .check-icon { opacity: 1; }
        .check-icon { opacity: 0; transition: opacity 0.2s; color: var(--brand-red); }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f3f4f6; padding: 12px; text-align: left; font-size: 0.85rem; text-transform: uppercase; color: #6b7280; font-weight: 600; }
        td { padding: 8px 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        
        input, select {
            background-color: #fff; border: 1px solid #d1d5db; color: #111827;
            padding: 8px 10px; border-radius: 6px; width: 100%; font-size: 14px; transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--brand-red); box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1); }

        .stepper-btn {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; background: #f3f4f6; cursor: pointer; user-select: none; transition: 0.2s;
            border: 1px solid #e5e7eb;
        }
        .stepper-btn:hover { background: #e5e7eb; }
        .stepper-btn:active { background: var(--brand-red); color: white; }

        .btn-primary { background-color: var(--brand-red); color: white; }
        .btn-primary:hover { background-color: #991b1b; }

        /* PDF Styles */
        #invoice-view { 
            position: fixed; top: 0; left: 0; width: 100%; height: auto; min-height: 100vh;
            background: white; z-index: 9999; padding: 40px; color: black; display: none;
        }
        
        .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; border: 1px solid #000; }
        .invoice-table th, .invoice-table td { border: 1px solid #000; padding: 5px; }
        
        @media print {
            body * { visibility: hidden; }
            #invoice-view, #invoice-view * { visibility: visible; display: block !important; }
            #invoice-view { position: absolute; top: 0; left: 0; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="app-ui" class="pb-24">
        <div class="bg-white border-b border-gray-200 py-6 mb-8">
            <div class="max-w-7xl mx-auto px-4 md:px-6">
                <div class="font-bold text-2xl tracking-tight text-gray-900">
                    <span class="text-red-700">Gloss</span> Master
                </div>
                <h1 class="text-2xl md:text-3xl font-light text-gray-600">Калькулятор фасадов (B2B)</h1>
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-2 md:px-6 space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="mat-card p-5 rounded-xl active relative" onclick="setGlobalMaterial(4500, this)">
                    <div class="absolute top-4 right-4 check-icon"><i data-lucide="check-circle-2"></i></div>
                    <h3 class="font-bold text-lg text-gray-800">Эмаль Матовая</h3>
                    <div class="mt-2 text-red-700 font-bold text-2xl">4 500 ₽ <span class="text-xs text-gray-400 font-normal">/ м²</span></div>
                </div>
                <div class="mat-card p-5 rounded-xl relative" onclick="setGlobalMaterial(5500, this)">
                    <div class="absolute top-4 right-4 check-icon"><i data-lucide="check-circle-2"></i></div>
                    <h3 class="font-bold text-lg text-gray-800">Эмаль Глянец</h3>
                    <div class="mt-2 text-red-700 font-bold text-2xl">5 500 ₽ <span class="text-xs text-gray-400 font-normal">/ м²</span></div>
                </div>
                <div class="mat-card p-5 rounded-xl relative" onclick="setGlobalMaterial(8500, this)">
                    <div class="absolute top-4 right-4 check-icon"><i data-lucide="check-circle-2"></i></div>
                    <h3 class="font-bold text-lg text-gray-800">Шпон / Спецэффекты</h3>
                    <div class="mt-2 text-red-700 font-bold text-2xl">8 500 ₽ <span class="text-xs text-gray-400 font-normal">/ м²</span></div>
                </div>
            </div>

            <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-semibold text-gray-700">Список деталей</h3>
                    <div class="flex gap-2">
                        <button onclick="clearAll()" class="text-red-600 hover:text-red-800 text-sm font-medium px-3 py-2 flex items-center gap-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Очистить
                        </button>
                        <button onclick="addRow()" class="btn-primary py-2 px-4 rounded-lg flex items-center gap-2 font-medium text-sm shadow-sm">
                            <i data-lucide="plus"></i> Добавить строку
                        </button>
                    </div>
                </div>
                <div class="table-container border-0 rounded-none shadow-none">
                    <table id="calcTable">
                        <thead>
                            <tr>
                                <th class="w-8 text-center">#</th>
                                <th class="w-28">Выс (мм)</th>
                                <th class="w-28">Шир (мм)</th>
                                <th class="w-20">Кол-во</th>
                                <th class="min-w-[200px]">Опции</th>
                                <th class="text-right w-32">Сумма</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="package-plus" class="text-red-700"></i> Комплектующие
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="border border-gray-200 p-4 rounded-lg flex flex-col justify-between hover:border-red-200 transition">
                        <div>
                            <div class="font-bold text-gray-800">Плинтус кухни</div>
                            <div class="text-xs text-gray-500 mb-2">Вставка + основа (3м)</div>
                            <div class="text-red-700 font-bold mb-3">1 200 ₽</div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 rounded p-1">
                            <div class="stepper-btn" onclick="updateAcc('plinth', -1)">-</div>
                            <span id="qty-plinth" class="font-bold w-8 text-center text-gray-800">0</span>
                            <div class="stepper-btn" onclick="updateAcc('plinth', 1)">+</div>
                        </div>
                    </div>
                    <div class="border border-gray-200 p-4 rounded-lg flex flex-col justify-between hover:border-red-200 transition">
                        <div>
                            <div class="font-bold text-gray-800">Цоколь ПВХ</div>
                            <div class="text-xs text-gray-500 mb-2">С уплотнителем (3м)</div>
                            <div class="text-red-700 font-bold mb-3">1 500 ₽</div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 rounded p-1">
                            <div class="stepper-btn" onclick="updateAcc('kick', -1)">-</div>
                            <span id="qty-kick" class="font-bold w-8 text-center text-gray-800">0</span>
                            <div class="stepper-btn" onclick="updateAcc('kick', 1)">+</div>
                        </div>
                    </div>
                    <div class="border border-gray-200 p-4 rounded-lg flex flex-col justify-between hover:border-red-200 transition">
                        <div>
                            <div class="font-bold text-gray-800">Заглушки</div>
                            <div class="text-xs text-gray-500 mb-2">Торцевые (металл)</div>
                            <div class="text-red-700 font-bold mb-3">300 ₽</div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 rounded p-1">
                            <div class="stepper-btn" onclick="updateAcc('caps', -1)">-</div>
                            <span id="qty-caps" class="font-bold w-8 text-center text-gray-800">0</span>
                            <div class="stepper-btn" onclick="updateAcc('caps', 1)">+</div>
                        </div>
                    </div>
                    <div class="border border-gray-200 p-4 rounded-lg flex flex-col justify-between hover:border-red-200 transition">
                        <div>
                            <div class="font-bold text-gray-800">Планки</div>
                            <div class="text-xs text-gray-500 mb-2">Соединительные</div>
                            <div class="text-red-700 font-bold mb-3">400 ₽</div>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 rounded p-1">
                            <div class="stepper-btn" onclick="updateAcc('strips', -1)">-</div>
                            <span id="qty-strips" class="font-bold w-8 text-center text-gray-800">0</span>
                            <div class="stepper-btn" onclick="updateAcc('strips', 1)">+</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="bg-gray-800 text-white p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="space-y-1 text-sm text-gray-300">
                    <p>Фасады: <span id="facadeTotal" class="text-white font-mono">0 ₽</span></p>
                    <p>Комплектующие: <span id="accTotal" class="text-white font-mono">0 ₽</span></p>
                </div>
                <div class="text-center md:text-right">
                    <div class="text-gray-400 text-xs uppercase tracking-wider mb-1">Итоговая стоимость</div>
                    <div id="grandTotal" class="text-3xl md:text-4xl font-bold text-white">0 ₽</div>
                </div>
            </section>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                
                <button onclick="sendToBitrix()" class="col-span-1 sm:col-span-2 bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-blue-700 transition flex justify-center items-center gap-2 shadow-lg">
                    <i data-lucide="rocket"></i> Оформить в CRM
                </button>

                <button onclick="shareToTelegram()" class="bg-sky-500 text-white font-semibold py-3 px-4 rounded-xl hover:bg-sky-600 transition flex justify-center items-center gap-2">
                    <i data-lucide="send"></i> TG (Поделиться)
                </button>

                <button onclick="sendToWhatsapp()" class="bg-green-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-green-700 transition flex justify-center items-center gap-2">
                    <i data-lucide="message-circle"></i> WhatsApp
                </button>

                <button onclick="downloadPDF()" class="col-span-1 sm:col-span-2 lg:col-span-4 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-50 transition flex justify-center items-center gap-2 mt-2">
                    <i data-lucide="file-down"></i> Скачать Смету (PDF)
                </button>
            </div>

        </main>
    </div>

    <div id="invoice-view"></div>

    <script>
        // --- TELEGRAM INIT ---
        const tg = window.Telegram.WebApp;
        
        // Настройка Телеграма
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            tg.expand(); // На весь экран
            // Красим шапку Телеграма в белый, чтобы сливалась с дизайном
            if (tg.setHeaderColor) tg.setHeaderColor('#ffffff');
            if (tg.setBackgroundColor) tg.setBackgroundColor('#f9fafb');
        });

        // --- КОНТАКТЫ И НАСТРОЙКИ ---
        const CONTACTS = {
            phone: "79284343345",         
            email: "mumorcevg@yandex.ru"
        };
        
        // ВСТАВЬТЕ СЮДА ВАШУ WEBHOOK ССЫЛКУ ИЗ MAKE
        const MAKE_WEBHOOK_URL = "https://hook.eu1.make.com/xxxxxxxxxxxxxxxxxxxx"; 

        let globalMatPrice = 4500;
        const ACC_PRICES = { plinth: 1200, kick: 1500, caps: 300, strips: 400 };
        const ACC_NAMES = { plinth: 'Плинтус кухни', kick: 'Цоколь ПВХ', caps: 'Заглушки', strips: 'Планки' };
        let accQty = { plinth: 0, kick: 0, caps: 0, strips: 0 };
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            if(!loadFromURL()) {
                loadFromLS();
            }

            if(document.getElementById('tableBody').children.length === 0) addRow();
        });

        // --- ЛОГИКА ССЫЛОК ---
        function getEditLink() {
            const r = [];
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                r.push([
                    tr.querySelector('.inp-h').value,
                    tr.querySelector('.inp-w').value,
                    tr.querySelector('.inp-q').value,
                    tr.querySelector('.inp-mill').value,
                    tr.querySelector('.inp-paint').value
                ]);
            });
            const a = [accQty.plinth, accQty.kick, accQty.caps, accQty.strips];
            const data = JSON.stringify({ m: globalMatPrice, r: r, a: a });
            const encoded = btoa(data);
            const url = window.location.href.split('?')[0] + '?d=' + encoded;
            return url;
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const dataStr = params.get('d');
            if(!dataStr) return false;

            try {
                const json = atob(dataStr);
                const data = JSON.parse(json);
                if(data.m) setGlobalMaterial(data.m, document.querySelector(`.mat-card[onclick*="${data.m}"]`) || document.querySelector('.mat-card'));
                if(data.a) {
                    accQty.plinth = data.a[0] || 0;
                    accQty.kick = data.a[1] || 0;
                    accQty.caps = data.a[2] || 0;
                    accQty.strips = data.a[3] || 0;
                    updateAccUI();
                }
                document.getElementById('tableBody').innerHTML = '';
                if(data.r && data.r.length > 0) {
                    data.r.forEach(row => {
                        addRow({ h: row[0], w: row[1], q: row[2], m: row[3], p: row[4] });
                    });
                }
                const header = document.querySelector('h1');
                if(header) {
                    header.innerHTML += ' <span class="text-red-500 text-sm align-middle">(Редактирование)</span>';
                }
                return true;
            } catch(e) {
                console.error("Ошибка чтения ссылки", e);
                return false;
            }
        }

        function updateAccUI() {
             Object.keys(accQty).forEach(k => { 
                const el = document.getElementById(`qty-${k}`);
                if(el) el.textContent = accQty[k];
            });
        }


        // --- СТАНДАРТНАЯ ЛОГИКА ---
        function setGlobalMaterial(price, el) {
            globalMatPrice = price;
            document.querySelectorAll('.mat-card').forEach(c => c.classList.remove('active'));
            if(el) el.classList.add('active');
            document.querySelectorAll('#tableBody tr').forEach(tr => calcRow(tr.querySelector('input')));
            calculateAll();
        }

        function addRow(data = null) {
            const tbody = document.getElementById('tableBody');
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 group';
            const v = data || { h: 716, w: 396, q: 1, m: 1, p: 1 };

            tr.innerHTML = `
                <td class="text-gray-400 text-center index-cell text-xs">#</td>
                <td><input type="number" value="${v.h}" class="inp-h placeholder-gray-300" placeholder="716" oninput="calcRow(this)"></td>
                <td><input type="number" value="${v.w}" class="inp-w placeholder-gray-300" placeholder="396" oninput="calcRow(this)"></td>
                <td><input type="number" value="${v.q}" class="inp-q text-center" oninput="calcRow(this)"></td>
                <td>
                    <div class="flex flex-col gap-2">
                        <select class="inp-mill text-sm" onchange="calcRow(this)">
                            <option value="1" ${v.m==1?'selected':''}>Гладкий</option>
                            <option value="1.3" ${v.m==1.3?'selected':''}>Фрезеровка (x1.3)</option>
                            <option value="1.5" ${v.m==1.5?'selected':''}>Интегр. ручка (x1.5)</option>
                        </select>
                        <select class="inp-paint text-sm" onchange="calcRow(this)">
                            <option value="1" ${v.p==1?'selected':''}>Одна сторона</option>
                            <option value="1.5" ${v.p==1.5?'selected':''}>Две стороны (x1.5)</option>
                        </select>
                    </div>
                </td>
                <td class="text-right font-mono font-bold text-gray-800 row-total">0</td>
                <td class="text-center">
                    <button onclick="removeRow(this)" class="text-gray-300 hover:text-red-500 p-2 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
            lucide.createIcons();
            updateIndices();
            calcRow(tr.querySelector('input'));
        }

        function removeRow(btn) {
            if(document.querySelectorAll('#tableBody tr').length > 1) {
                btn.closest('tr').remove();
                updateIndices();
                calculateAll();
            }
        }

        function updateIndices() {
            document.querySelectorAll('.index-cell').forEach((c, i) => c.textContent = i + 1);
        }

        function updateAcc(key, delta) {
            accQty[key] = Math.max(0, accQty[key] + delta);
            document.getElementById(`qty-${key}`).textContent = accQty[key];
            calculateAll();
        }

        function calcRow(el) {
            const tr = el.closest('tr');
            const h = (parseFloat(tr.querySelector('.inp-h').value) || 0) / 1000;
            const w = (parseFloat(tr.querySelector('.inp-w').value) || 0) / 1000;
            const q = parseInt(tr.querySelector('.inp-q').value) || 0;
            const mill = parseFloat(tr.querySelector('.inp-mill').value);
            const paint = parseFloat(tr.querySelector('.inp-paint').value);
            let price = (h * w * globalMatPrice * mill * paint * q);
            tr.querySelector('.row-total').textContent = Math.round(price).toLocaleString();
            tr.dataset.val = price;
            calculateAll(); 
        }

        function calculateAll() {
            let facadeSum = 0;
            document.querySelectorAll('#tableBody tr').forEach(tr => { facadeSum += parseFloat(tr.dataset.val || 0); });
            let accSum = 0;
            for (const [key, qty] of Object.entries(accQty)) { accSum += qty * ACC_PRICES[key]; }
            const total = facadeSum + accSum;
            document.getElementById('facadeTotal').textContent = Math.round(facadeSum).toLocaleString() + ' ₽';
            document.getElementById('accTotal').textContent = Math.round(accSum).toLocaleString() + ' ₽';
            document.getElementById('grandTotal').textContent = Math.round(total).toLocaleString() + ' ₽';
            
            if(!window.location.search.includes('d=')) {
                saveData();
            }
        }

        function saveData() {
            const rows = [];
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                rows.push({
                    h: tr.querySelector('.inp-h').value, w: tr.querySelector('.inp-w').value,
                    q: tr.querySelector('.inp-q').value, m: tr.querySelector('.inp-mill').value,
                    p: tr.querySelector('.inp-paint').value
                });
            });
            const data = { rows, accQty, globalMatPrice };
            localStorage.setItem('glossMasterCalc', JSON.stringify(data));
        }

        function loadFromLS() {
            const saved = JSON.parse(localStorage.getItem('glossMasterCalc'));
            if(!saved) return;
            if(saved.globalMatPrice) setGlobalMaterial(saved.globalMatPrice, document.querySelector(`.mat-card[onclick*="${saved.globalMatPrice}"]`) || document.querySelector('.mat-card'));
            if(saved.accQty) {
                Object.keys(saved.accQty).forEach(k => { 
                    accQty[k] = saved.accQty[k]; 
                    const el = document.getElementById(`qty-${k}`);
                    if(el) el.textContent = accQty[k];
                });
            }
            if(saved.rows && saved.rows.length > 0) {
                document.getElementById('tableBody').innerHTML = '';
                saved.rows.forEach(r => addRow(r));
            }
        }
        
        function clearAll() {
            // Используем нативное подтверждение TG
            tg.showConfirm('Очистить таблицу и создать новый заказ?', (confirmed) => {
                if (confirmed) {
                    document.getElementById('tableBody').innerHTML = '';
                    addRow();
                    Object.keys(accQty).forEach(k => { accQty[k] = 0; document.getElementById(`qty-${k}`).textContent = 0; });
                    localStorage.removeItem('glossMasterCalc');
                    window.history.pushState({}, document.title, window.location.pathname);
                    const header = document.querySelector('h1');
                    if(header) header.innerHTML = header.innerHTML.replace(' <span class="text-red-500 text-sm align-middle">(Редактирование)</span>', '');
                    calculateAll();
                }
            });
        }

        function getOrderText() {
            const total = document.getElementById('grandTotal').textContent;
            let text = `Заказ Gloss Master:\n\n`;
            document.querySelectorAll('#tableBody tr').forEach((tr, i) => {
                const h = tr.querySelector('.inp-h').value;
                const w = tr.querySelector('.inp-w').value;
                const q = tr.querySelector('.inp-q').value;
                const mill = tr.querySelector('.inp-mill option:checked').text;
                text += `${i+1}. ${h}x${w} - ${q} шт. (${mill})\n`;
            });
            let hasAcc = false;
            for (const [key, val] of Object.entries(accQty)) {
                if (val > 0) {
                    if(!hasAcc) { text += `\nКомплектующие:\n`; hasAcc = true; }
                    text += `${ACC_NAMES[key]}: ${val} шт.\n`;
                }
            }
            text += `\nИТОГО: ${total}`;
            return text;
        }

        // --- ОТПРАВКА ---
        function sendToWhatsapp() {
            const text = getOrderText() + `\n\nСсылка на заказ: ` + getEditLink();
            window.open(`https://wa.me/${CONTACTS.phone}?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareToTelegram() {
            const text = getOrderText() + `\n\nСсылка на заказ: ` + getEditLink();
            // Внутри Telegram Web App используем специальный метод
            const url = `https://t.me/share/url?url=${encodeURIComponent(getEditLink())}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(url);
        }

        // --- ОТПРАВКА В БИТРИКС (MAKE) С УЧЕТОМ TELEGRAM USER ---
        async function sendToBitrix() {
            const btn = document.querySelector('button[onclick="sendToBitrix()"]');
            if(btn) { btn.textContent = "Отправка..."; btn.disabled = true; }

            // 1. Пытаемся взять имя из Telegram
            let defaultName = "Клиент с сайта";
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                defaultName = `${user.first_name} ${user.last_name || ''} (@${user.username || 'no_user'})`.trim();
            }

            // 2. Телефон все равно спрашиваем (TG не отдает его просто так)
            // Но мы используем нативный popup, если возможно, или обычный prompt
            const phone = prompt("Введите номер телефона КЛИЕНТА:", "+7");
            
            if(!phone) { 
                if(btn) { btn.textContent = "Оформить в CRM"; btn.disabled = false; } 
                return; 
            }
            
            const totalSum = document.getElementById('grandTotal').textContent;
            const editLink = getEditLink();
            const textOrder = getOrderText();

            const payload = {
                contact: { 
                    phone: phone, 
                    name: defaultName 
                },
                deal: {
                    title: `Заказ TG ${totalSum}`,
                    description: `${textOrder}\n\n=================\n✏️ ИЗМЕНИТЬ ЗАКАЗ:\n${editLink}\n=================`,
                    opportunity: parseFloat(totalSum.replace(/\D/g, '')),
                }
            };

            try {
                if(MAKE_WEBHOOK_URL.includes("xxxx")) {
                    tg.showAlert("Ошибка: Не настроен Webhook!");
                } else {
                    await fetch(MAKE_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    tg.showAlert("✅ Заказ успешно создан в Битрикс24!");
                }
            } catch (e) {
                console.error(e);
                tg.showAlert("Ошибка отправки. Проверьте интернет.");
            }
            if(btn) { btn.textContent = "Оформить в CRM"; btn.disabled = false; }
        }

        // --- PDF ---
        function generateInvoiceHTML() {
            const date = new Date().toLocaleDateString();
            const total = document.getElementById('grandTotal').textContent;
            let html = `<div style="border-bottom: 2px solid #b91c1c; padding-bottom: 10px; margin-bottom: 20px;"><h1 style="font-size: 24px; margin:0;">СМЕТА: GLOSS MASTER</h1><p style="margin:5px 0 0 0; color:#555;">Дата: ${date}</p></div><table class="invoice-table"><thead><tr><th style="width: 5%">#</th><th style="width: 45%">Наименование</th><th style="width: 15%">Кол-во</th><th style="width: 35%; text-align: right">Сумма</th></tr></thead><tbody>`;
            
            document.querySelectorAll('#tableBody tr').forEach((tr, i) => {
                const h = tr.querySelector('.inp-h').value;
                const w = tr.querySelector('.inp-w').value;
                const q = tr.querySelector('.inp-q').value;
                const mill = tr.querySelector('.inp-mill option:checked').text;
                const price = tr.querySelector('.row-total').textContent;
                html += `<tr><td style="text-align: center">${i+1}</td><td>Фасад ${h}x${w} (${mill})</td><td style="text-align: center">${q}</td><td style="text-align: right; font-weight: bold">${price}</td></tr>`;
            });
            for (const [key, val] of Object.entries(accQty)) {
                if (val > 0) {
                    const price = (val * ACC_PRICES[key]).toLocaleString();
                    html += `<tr><td style="text-align: center">-</td><td>${ACC_NAMES[key]}</td><td style="text-align: center">${val}</td><td style="text-align: right; font-weight: bold">${price}</td></tr>`;
                }
            }
            html += `</tbody></table><h2 style="text-align: right; margin-top: 20px;">ИТОГО: ${total}</h2>`;
            return html;
        }

        function downloadPDF() {
            const content = generateInvoiceHTML();
            const view = document.getElementById('invoice-view');
            view.innerHTML = content;
            view.style.display = 'block';
            const opt = { margin: 10, filename: 'Smeta.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            setTimeout(() => { html2pdf().set(opt).from(view).save().then(() => { view.style.display = 'none'; }); }, 100);
        }
    </script>
</body>
</html>
